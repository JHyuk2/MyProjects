# 4. Local Test (llama3)

실제로 모델이 돌아갔을 때, 어떤 식으로 답변하는지를 확인하기 위해 로컬 테스트를 실행함.

실험 코드는 **llama3-starter code(LB750)**



### 1. python code

얼마 전, Gemma2가 새로 나왔는데 long-context를 잘 처리한다고 한다…!

그래서, gemma2를 사용한 code를 찾아보던 중 아래의 코드를 발견



#### `python code for local test`

```python
!wget -O keywords_local.py <https://raw.githubusercontent.com/Kaggle/kaggle-environments/master/kaggle_environments/envs/llm_20_questions/keywords.py>
```

- `keywords.py` 안의 키워드들을 바탕으로 실험을 시작!

```python
import json
import pandas as pd
from submission.main import agent
from keywords_local import KEYWORDS_JSON

class Observation:
    def __init__(self):
        self.step = 0
        self.role = "guesser"
        self.turnType = "ask"
        self.keyword = "Japan"
        self.category = "country"
        self.questions = []
        self.answers = []
        self.guesses = []

def create_keyword_df(KEYWORDS_JSON):
    json_data = json.loads(KEYWORDS_JSON)

    keyword_list = []
    category_list = []
    alts_list = []

    for i in range(len(json_data)):
        for j in range(len(json_data[i]['words'])):
            keyword = json_data[i]['words'][j]['keyword']
            keyword_list.append(keyword)
            category_list.append(json_data[i]['category'])
            alts_list.append(json_data[i]['words'][j]['alts'])

    data_pd = pd.DataFrame(columns=['keyword', 'category', 'alts'])
    data_pd['keyword'] = keyword_list
    data_pd['category'] = category_list
    data_pd['alts'] = alts_list

    return data_pd

keywords_df = create_keyword_df(KEYWORDS_JSON)
obs = Observation()
cfg = "_"

sample_df = keywords_df.sample()
obs.keyword = sample_df["keyword"].values[0]
obs.category = sample_df["category"].values[0]
alts_list = sample_df["alts"].values[0]
alts_list.append(obs.keyword)

print(f"keyword:{obs.keyword}")

for round in range(20):
    obs.step = round+1

    obs.role = "guesser"
    obs.turnType = "ask"
    question = agent(obs, cfg)
    obs.questions.append(question)

    obs.role = "answerer"
    obs.turnType = "answer"
    answer = agent(obs, cfg)
    obs.answers.append(answer)

    obs.role = "guesser"
    obs.turnType = "guess"
    guess = agent(obs, cfg)
    obs.guesses.append(guess)

    print(f"round: {round+1}")
    print(f"question: {question}")
    print(f"answer: {answer}")
    print(f"guess: {guess}")

    if guess in alts_list:
        print("Win!!")
        break
```



### 2. 실행 결과

### **예시 1.**

> keyword:davao city philippines
>
> round: 1 question: Is it a place? answer: yes guess: Paris 
>
> round: 2 question: Is it in Europe? answer: no guess: Australia 
>
> round: 3 question: Is it in Asia? answer: yes guess: Tokyo 
>
> round: 4 question: Is it a country? answer: no guess: Tokyo 
>
> round: 5 question: Is it a city? answer: yes guess: Tokyo 
>
> round: 6
>
> - --`여기부터 문제 발생`
>
> **question: Is it a capital city?** answer: no **guess: Tokyo**
>
> round: 7 question: Is it a city in China? answer: no **guess: Tokyo** 
>
> round: 8 question: Is it a city in Japan? answer: no **guess: Seoul** 
>
> round: 9 question: Is it a city in India? answer: no guess: Bangkok 
>
> round: 10 **question: Is it a city in Southeast Asia? answer: yes** guess: Bangkok 
>
> round: 11 question: Is it a city in Indonesia? answer: no guess: Bangkok 
>
> round: 12 question: Is it a city in Thailand? answer: no guess: Ho Chi Minh City 
>
> round: 13 question: Is it a city in Vietnam? answer: no guess: Bangkok 
>
> round: 14 question: Is it a city in Malaysia? answer: no guess: Bangkok
>
>  round: 15 question: Is it a city in Singapore? answer: no guess: Bangkok 
>
> round: 16 question: Is it a city in Cambodia? answer: no guess: Bangkok 
>
> round: 17 question: Is it a city in Laos? answer: no guess: Bangkok 
>
> round: 18 question: Is it a city in Myanmar? answer: no guess: Bangkok 
>
> round: 19 question: Is it a city on the island of Bali? answer: no guess: Phnom Penh 
>
> round: 20 question: Is it a city on the island of Phuket? answer: no guess: Ho Chi Minh City



### **발생 문제**

1. **질문에 대한 저열한 예측 성능**

   - 에이전트가 질문에 대한 답변에 일치하지 않는 추측을 반복한다.

     ex) "Is it a capital city?" > "no" > "guess: Tokyo, Tokyo, Seoul..."

2. **지역의 범위 축소에 대한 잘못된 이해**

   - 지역의 범위를 점진적으로 좁혀가는 것이 아니라, 무작위로 찍어서 접근함.

     "Is it a city in Southeast Asia?"> "Yes" 의 질문을 들었을 때 추측 로직이 개선되어야 함.

     ex) 대륙 -> 지역 -> 나라 -> 섬/주 -> 도시 순으로 질문하기여 범위를 좁혀야 함.

3. **기억을 못함.**

   - 1번 문제와 엇물리는 내용인데...

     capital city가 아닌 것들을 예측해야하는데 그 아래 예측들을 보면 전부 수도임.

### **예시 2.**

> keyword:Mural (벽화)
>
> round: 1 question: Is it a place? answer: no guess: Person 
>
> round: 2 question: Is it a person? answer: no guess: thing 
>
> round: 3 question: Is it a thing? answer: yes guess: Book 
>
> round: 4 question: Is it man-made? answer: yes guess: Chair 
>
> round: 5 question: Is it something that can be held in your hand? answer: no guess: Building 
>
> round: 6 question: Is it used for transportation? answer: no guess: Building 
>
> round: 7 question: Is it electronic? answer: no guess: Building 
>
> round: 8 **question: Is it used for entertainment?**
>
> **answer: yes**
>
> **guess: Theater** 
>
> round: 9 question: Is it used for playing music? answer: no guess: Book 
>
> round: 10 **question: Is it used for watching movies or TV shows?**
>
> **answer: yes**
>
> **guess: Theater** 
>
> round: 11 question: Is it a screen? answer: yes guess: TV 
>
> round: 12 question: Is it a TV? answer: yes guess: TV 
>
> round: 13 question: Is it a smart TV? answer: no guess: TV 
>
> round: 14 question: Is it a CRT TV? answer: no guess: TV

### **발생 문제**

1. **모호한 질문**

   - 질문들이 너무 모호해서 정보를 얻기가 어려움. 질문이 구체적으로 바뀌어야 함.

     ex) "Is it used for entertainment?" > "Is it an object related to visual art?"

2. **정답과 너무나 멀어져버린 답변**`(이전 context를 기억 못하는 느낌)`

   - 키워드는 벽화였는데, TV쇼를 보기 위한 무언가로 바뀌어버림. 또한, TV만 계속 말함.

     ex) "Is it used for watching movies or TV shows?" > "Yes"

3. **추측의 다양화 필요**

   - "Is it a TV?" > "yes" 의 답변을 얻었는데도 불구하고, guess는 TV로 고정됨.

     애초에 답을 틀려서 생긴 문제이지만, 답을 못맞춘다면 질문이 잘못됨을 인지해야 함.



### **그 외 답변들도 참 참신했다.**

ex) 덤벨이 플라스틱이라고 한다던가... 비누는 입안 청결을 위한 플라스틱 제품이 되었다.



### **3. 문제 수정**

해결해야 할 문제를 간단하게 적어보면 다음과 같다.

1. 기억과 추록 강화
   - **이전 답변을 바탕으로** 질문과 답변을 하도록 설계
2. 정답 범위 축소에 대한 이해 강화
   - 구체적이고 명확한 질문을 통해 정보를 얻고, 정보 기반으로 추측

#### **3.1. prompt engineering**

GPT의 도움을 받아 질문을 조금 더 간결하게 바꿔보았다.

- 프롬프트 수정

  ```python
  """
  ** asker **
  # 원본
  to help you, here's an example of how it should work assuming that the keyword is Morocco:
  example...
  
  # 수정
  Please be concise. Here is an example conversation for the keyword 'Morocco':
  example...
  ---------------------------------------------
  ** guess **
  
  # 원본
  can you guess the word
  # 수정
  guess the word
  """
  ```

> 간결한 명령문으로 수정



#### **3.2. 이전 질문과 답변 기억**

```python
for q, a in zip(obs.questions, obs.answers):
		chat_template += f"{q}<|eot_id|><|start_header_id|>user<|end_header_id|>\\n\\n"
		chat_template += f"{a}<|eot_id|><|start_header_id|>assistant<|end_header_id|>\\n\\n"
chat_template += f"Question: {obs.questions[-1]}\\n" # 이전 내용을 기억...?
```

---



**다음 계획**

- llama3-8b 모델 돌려보기
- RAG와 VectorDB 이해하기

**참고 자료**

- [devocean](https://devocean.sk.com/blog/techBoardDetail.do?ID=165872&boardType=techBlog)